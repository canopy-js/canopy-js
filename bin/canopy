#!/bin/bash
set -x
case $1 in
build)
  if [ ! -d ./topics ]; then
    echo "There must be a 'topics' directory at the current path"
    exit 1
  fi

  PROJECT_DIRECTORY_PATH=$PWD
  DEFAULT_TOPIC=`cat .canopy_default_topic`
  PATH_PREFIX=`cat .canopy_path_prefix`
  PATH_TO_BUILD=build

  rm -rf build

  if [ -s .canopy_path_prefix ]; then
    if [ "$CREATE_LOCAL_DIRECTORY_NAMESPACE" == true ]; then
      PATH_TO_BUILD=build/$PATH_PREFIX
    fi
  fi

  mkdir -p $PATH_TO_BUILD
  cd $PATH_TO_BUILD

  cat << EOF > index.html
  <html>
  <head>
  <meta charset="utf-8">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  </head>
  <body>
  <div id="_canopy" data-default-topic="$DEFAULT_TOPIC" data-path-prefix="$PATH_PREFIX"></div>
  <script src="$PATH_PREFIX/canopy.js"></script>
  </body>
  </html>
EOF

  CANOPY_LOCATION="${CANOPY_LOCATION:- $(npm root -g)}"

  CANOPY_DEBUG=true \
    PATH_TO_BUILD=$PATH_TO_BUILD \
    node $CANOPY_LOCATION/canopy-js/dist/parser.js $PROJECT_DIRECTORY_PATH $2

  if [[ $2 = "--with-folders" ]]; then
    for D in `find "build" ! -name '*_data' -type d -mindepth 1`; do
      cp $PATH_TO_BUILD/index.html $D
    done

    for CURRENT_TOPIC_PATH in `find "." ! -name '*_data' -type d -mindepth 1`; do
      for TOPIC_TO_ALIAS_PATH in `find "." ! -name '*_data' -type d -mindepth 1`; do
        echo rm -f $CURRENT_TOPIC_PATH/$(basename $TOPIC_TO_ALIAS_PATH)
        rm -f $CURRENT_TOPIC_PATH/$(basename $TOPIC_TO_ALIAS_PATH)
        cd $CURRENT_TOPIC_PATH
        pwd
        echo ln -s ../$(basename $TOPIC_TO_ALIAS_PATH) $CURRENT_TOPIC_PATH/$(basename $TOPIC_TO_ALIAS_PATH)
        ln -s ../$(basename $TOPIC_TO_ALIAS_PATH) $(basename $TOPIC_TO_ALIAS_PATH)
        cd ..
      done
    done
    cd ..
  fi

  cp $(npm root -g)/canopy-js/dist/canopy.js $PROJECT_DIRECTORY_PATH/$PATH_TO_BUILD/canopy.js
;;
update)
  cd /usr/local/lib/canopy
  git pull origin master
  cp dist/canopy.sh /usr/local/bin/canopy
  echo Update success;;
init)
  mkdir topics
  touch .gitignore
  echo "build/" >> .gitignore
  echo ".canopy_watch.pid" >> .gitignore
  echo ".canopy_bulk_temp" >> .gitignore
  echo "canopy_bulk_temp" >> .gitignore
  echo "Enter default topic name:"
  read DEFAULT_TOPIC
  echo $DEFAULT_TOPIC > .canopy_default_topic
  echo $DEFAULT_TOPIC | node $(npm root -g)/canopy-js/script/snake_case.js
  echo "${DEFAULT_TOPIC}: Text here." > $(echo $DEFAULT_TOPIC | node $(npm root -g)/canopy-js/script/snake_case.js)
  echo "Canopy supports hosting on a static assets server."
  echo "However, Canopy must know if it is being served from a path besides the hostname"
  echo "(eg, example.com/your_name/Topic, as opposed to example.com/Topic )"
  echo "So, if you will be hosting with a namespace, type it below."
  echo "Otherwise, just press enter."
  read PATH_PREFIX
  echo $PATH_PREFIX > .canopy_path_prefix
  ;;
watch)
  command -v fswatch >/dev/null 2>&1 || { echo >&2 "Canopy watch requires fswatch to be installed."; exit;}

  if [ "$2" == "stop" ]; then
    kill $(cat .canopy_watch.pid) > /dev/null 2>&1;
    rm .canopy_watch.pid
    exit 0;
  fi

  PIDFILE=.canopy_watch.pid
  if [ -f $PIDFILE ];
  then
    PID=$(cat $PIDFILE)
    if ps -p $PID > /dev/null 2>&1;
    then
      # Canopy watch is already running
      kill $PID
    fi
  fi

  if [ ! -d ./topics ]; then
    echo "There must be a topics directory at the current path"
    exit 1
  fi

  #######
  fswatch -0 -o topics | CANOPY_DEBUG=true xargs -0 -n1 -I{} canopy build > /dev/null 2>&1 &
  #######

  echo $(jobs -p | tail -1) > $PIDFILE
  if [ $? -ne 0 ];
  then
    echo "Could not create PID file"
    exit 1
  fi

  canopy build;;
serve)
  canopy build
  node $(npm root -g)/canopy-js/dist/server.js ${2:-3000}
  ;;

bulk)
  node $(npm root -g)/canopy-js/script/bulk_edit.js "$@"
  ;;

?|usage)
echo "Usage:"
echo "  canopy update"
echo "  canopy init"
echo "  canopy build [--with-folders]"
echo "  canopy watch"
echo "  canopy watch stop"
echo "  canopy serve [PORT]"
echo "  canopy bulk [--start|--stop] [PATHS]"
;;
*)
  echo Unknown command;;
esac
