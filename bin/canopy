#!/usr/bin/env node

const { Command, Option } = require('commander');
const init = require('./commands/init');
const build = require('./commands/build');
const watch = require('./commands/watch');
const serve = require('./commands/serve/serve');
const bulk = require('./commands/bulk/bulk');

const program = new Command();

program
  .name('canopy-js')
  .description('A library for creating explanation trees');

program.command('init')
  .description('Initialize a Canopy project')
  .action(() => {
  	try {
      init();
    } catch (e) {
      console.error(e);
    }
  });

program.command('build')
  .description('build the Canopy text files into JSON data')
  .option('-s, --symlinks', 'builds symlinked topic folders for static assets server', false)
  .option('-h, --hash-urls', 'build site for use with hangbang URLs', false)
  .option('-p, --project-path-prefix <prefix>', 'for hosting on a domain with a subpath eg example.com/sub/', '')
  .option('-n, --new-build-directory', 'Remove recursively the previous build directory and create new', false)
  .option('-m, --manual-html', 'Do not create an index.html but rather allow user to create one', false)
  .action((options) => {
    try {
    	build(options);
    } catch (e) {
      console.error(e);
    }
  });

program.command('watch')
  .description('watch a Canopy project and rebuild JSON assets on text change')
  .argument('[mode]', 'whether to start or stop Canopy watch', 'start')
  .option('-s, --symlinks', 'builds symlinked topic folders for static assets server', false) //build options
  .option('-h, --hashbang-urls', 'build site for use with hangbang URLs', false)
  .option('-p, --project-path-prefix <prefix>', 'for hosting on a domain with a subpath eg example.com/subpath/', '')
  .action((argument, options) => {
  	watch(argument, options);
  });

program.command('serve')
  .description('run a server for a Canopy project')
  .addOption(new Option('-p, --port <number>', 'port number').env('PORT').default(8000))
  .option('-s, --static', 'run a static assets server instead of a node.js server', false)
  .action((options) => {
    try {
      serve(options);
    } catch (e) {
      console.error(e);
    }
  });

program.command('bulk')
  .description('watch a Canopy project and rebuild JSON assets on text change')
  .addOption(new Option('--start', 'choose file paths with fuzzy selector').conflicts('finish'))
  .addOption(new Option('--finish', 'import finished session from canopy_bulk_file').conflicts('start'))
  .addOption(new Option('-p, --pick', 'choose file paths with fuzzy selector').conflicts('finish'))
  .addOption(new Option('-b, --blank', 'choose file paths with fuzzy selector').conflicts('finish'))
  .addOption(new Option('-d, --directories', 'used in conjunction with --pick, allows the user to select directories of files').conflicts(['recursive', 'finish']).implies({ pick: true }))
  .addOption(new Option('-r, --recursive', 'used in conjunction with --pick, allows selection of recursive directory contents').conflicts(['directories', 'finish']).implies({ pick: true }))
  .addOption(new Option('-g, --git', 'edit files edited on the git stage, and untracked files').conflicts('finish'))
  .addOption(new Option('-s, --search <string>', 'edit files matching a certain string case insensitive').conflicts('finish'))
  .addOption(new Option('-c, --continue', 'resume a session from dotfile on disk').conflicts(['start', 'finish', 'pick', 'git', 'search', 'blank']))
  .option('-n, --no-backup', 'clear the backup file and do not write to it')
  .argument('[paths...]')
  .action((paths, options) => {
  	bulk(paths, options).catch((e) => console.error(e));
  });

program.parse();
