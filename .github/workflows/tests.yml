name: Tests
on:
  workflow_call:
    outputs:
      done:
        description: "Signal that all tests are complete"
        value: ${{ jobs.all-tests.outputs.done }}

jobs:
  jest:
    name: Jest Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - id: cache-key
        run: echo "key=playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - run: npm ci
      - run: npm install -g .
      - run: npx playwright install --with-deps
      - run: npm run jest

  playwright-tests:
    name: Playwright (${{ matrix.target.id }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        target:
          - id: nav
            cmd: npx playwright test playwright/navigation.spec.js
          - id: style
            cmd: npx playwright test playwright/style.spec.js
          - id: rest
            cmd: npx playwright test $(find ./playwright -name '*.spec.js' ! -name 'navigation.spec.js' ! -name 'style.spec.js')
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - id: cache-key
        run: echo "key=playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - run: npm ci
      - run: npm run build-prod
      - run: npm install -g .
      - run: npx playwright install --with-deps
      - run: ${{ matrix.target.cmd }} --max-failures=1
      - name: Upload test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.target.id }}
          path: test-results/

      - name: Upload playwright-report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.target.id }}
          path: playwright-report/

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - run: npm ci
      - run: npm run lint

  all-tests:
    name: All Tests Complete
    runs-on: ubuntu-latest
    needs: [jest, playwright-tests, lint]
    if: always()
    outputs:
      done: true
    steps:
      - run: echo "All tests complete"
